name: CI

on:
  pull_request:
    branches: [ main, master ]
  push:
    branches: [ main, master ]

jobs:
  code-validation:
    name: Code Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Check Python syntax
      run: |
        python3 validate_code.py

    - name: Run comprehensive checks
      run: |
        python3 check_all.py

    - name: Check file structure
      run: |
        echo "Checking required files..."
        test -f README.md || (echo "Missing README.md" && exit 1)
        test -f requirements.txt || (echo "Missing requirements.txt" && exit 1)
        test -f setup.py || (echo "Missing setup.py" && exit 1)
        test -f pyproject.toml || (echo "Missing pyproject.toml" && exit 1)
        echo "✓ All required files present"

  test-with-dependencies:
    name: Test with Dependencies
    runs-on: ubuntu-latest
    needs: code-validation

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Test imports
      run: |
        python -c "from src.models import HierarchicalModel; print('✓ Models import OK')"
        python -c "from src.data import CellularDataPreprocessor; print('✓ Data import OK')"
        python -c "from src.training import Trainer; print('✓ Training import OK')"
        python -c "from src.utils import compute_metrics; print('✓ Utils import OK')"
        python -c "from src.analysis import HierarchicalModelAnalyzer; print('✓ Analysis import OK')"

    - name: Run unit tests
      run: |
        pytest tests/test_models.py -v
        pytest tests/test_data.py -v
        pytest tests/test_training.py -v

    - name: Run integration tests
      run: |
        pytest tests/test_integration.py -v

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install linting tools
      run: |
        pip install flake8 black isort

    - name: Check code formatting with Black
      run: |
        black --check --diff src/ tests/ scripts/ || echo "⚠ Consider running 'black src/ tests/ scripts/'"

    - name: Check import sorting with isort
      run: |
        isort --check-only --diff src/ tests/ scripts/ || echo "⚠ Consider running 'isort src/ tests/ scripts/'"

    - name: Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 src/ tests/ scripts/ --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 src/ tests/ scripts/ --count --exit-zero --max-complexity=15 --max-line-length=100 --statistics

  build-check:
    name: Build Package Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install build tools
      run: |
        pip install build wheel

    - name: Build package
      run: |
        python -m build

    - name: Check dist files
      run: |
        test -d dist || (echo "dist directory not created" && exit 1)
        ls -lh dist/
        echo "✓ Package built successfully"
